<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
		Relación de consultas para las vistas de IMOX
-->
<process>
	<dml> 
    <unit id="VistaClientesCitasDto">
      <select id="lazy">
select
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.id_cita_estatus,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.recordatorio,
  tc_mantic_clientes.limite_credito,
  tc_mantic_clientes.saldo,
  tc_kalan_citas_estatus.nombre as estatus,
  concat(tc_mantic_personas.nombres, ' ', tc_mantic_personas.paterno, ' ', tc_mantic_personas.materno) as atendio,      
  tc_kalan_citas.registro,
  group_concat(tc_mantic_articulos.nombre separator ', ') as servicios        
from      
  tc_mantic_clientes
inner join ( 
	select
		tc_kalan_citas.id_cita as id_cita,
    tc_kalan_citas.id_cliente
	from
		tc_kalan_citas
	where
	  (tc_kalan_citas.id_cliente= {idCliente} or {idCliente}= -1)        
    and tc_kalan_citas.id_cita_estatus!= 6
	group by	
	 tc_kalan_citas.id_cliente,
	 tc_kalan_citas.id_cita
) as tt_kalan_citas on tc_mantic_clientes.id_cliente= tt_kalan_citas.id_cliente
inner join
  tc_kalan_citas on tt_kalan_citas.id_cita= tc_kalan_citas.id_cita
inner join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
inner join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
inner join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
left join
  tc_janal_usuarios on tc_kalan_citas.id_atendio= tc_janal_usuarios.id_usuario          
left join
  tc_mantic_personas on tc_janal_usuarios.id_persona= tc_mantic_personas.id_persona
where 
  tc_mantic_clientes.id_empresa in ({sucursales})
  and {condicion}
group by
  tc_mantic_clientes.id_cliente,
  tc_kalan_citas.id_cita
{sortOrder}
      </select>
      <select id="nombre">
select
  tc_kalan_citas.id_cita as id_key,
  tc_kalan_citas.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_citas.recordatorio,
  tc_kalan_citas.id_cita_estatus,
  tc_kalan_citas_estatus.nombre as estatus
from
  tc_kalan_citas
inner join
  tc_mantic_clientes on tc_kalan_citas.id_cliente= tc_mantic_clientes.id_cliente
inner join
  tc_kalan_citas_estatus on tc_kalan_citas.id_cita_estatus= tc_kalan_citas_estatus.id_cita_estatus
where
  tc_kalan_citas.id_cita_estatus!= 6      
  and {condicion}
order by
  tc_mantic_clientes.razon_social, 
  tc_mantic_clientes.paterno, 
  tc_mantic_clientes.materno
      </select>
      <select id="clientes">
select      
  tc_mantic_clientes.id_cliente as id_key,
  tc_mantic_clientes.id_cliente,
  tc_mantic_clientes.clave,
  tc_mantic_clientes.rfc,
  tc_mantic_clientes.razon_social,
  tc_mantic_clientes.paterno,
  tc_mantic_clientes.materno,
  tc_mantic_clientes.limite_credito,
  tc_mantic_clientes.saldo,
  concat(tc_mantic_clientes.razon_social, ' ', ifnull(tc_mantic_clientes.paterno, ''), ' ', ifnull(tc_mantic_clientes.materno, '')) as cliente,
  tc_kalan_citas.id_cita,
  tc_kalan_citas.consecutivo,
  tc_kalan_citas.inicio,
  tc_kalan_citas.termino,
  tc_kalan_citas.registro,
  group_concat(tc_mantic_articulos.nombre separator ', ') as servicios        
from      
  tc_mantic_clientes
left join ( 
	select
		max(tc_kalan_citas.id_cita) as id_cita,
    tc_kalan_citas.id_cliente
	from
		tc_kalan_citas
	where
		(tc_kalan_citas.id_cliente= {idCliente} or {idCliente}= -1)
    and tc_kalan_citas.id_cita_estatus!= 6
	group by	
	 tc_kalan_citas.id_cliente
) as tt_kalan_citas on tc_mantic_clientes.id_cliente= tt_kalan_citas.id_cliente
left join
  tc_kalan_citas on tt_kalan_citas.id_cita= tc_kalan_citas.id_cita
left join
  tc_kalan_citas_detalles on tc_kalan_citas.id_cita= tc_kalan_citas_detalles.id_cita
left join
  tc_mantic_articulos on tc_kalan_citas_detalles.id_articulo= tc_mantic_articulos.id_articulo
where 
  tc_mantic_clientes.id_empresa in ({sucursales})
  and {condicion}
group by
  tc_mantic_clientes.id_cliente       
order by
  tc_mantic_clientes.razon_social, 
  tc_mantic_clientes.paterno, 
  tc_mantic_clientes.materno
      </select>
      <select id="personal">
select
  tc_mantic_personas.id_persona as id_key,
  tr_mantic_empresa_personal.id_empresa_persona,
  concat(tc_mantic_personas.nombres, ' ', ifnull(tc_mantic_personas.paterno, ''), ' ', ifnull(tc_mantic_personas.materno, '')) as empleado
from
  tr_mantic_empresa_personal
inner join
  tc_mantic_personas on tr_mantic_empresa_personal.id_persona= tc_mantic_personas.id_persona
where
  tr_mantic_empresa_personal.id_empresa in ({sucursales})
  and tr_mantic_empresa_personal.id_activo= 1
order by
  tc_mantic_personas.nombres, 
  tc_mantic_personas.paterno,
  tc_mantic_personas.materno	
      </select>
  	  <select id="servicios">
select
  tc_mantic_articulos.id_articulo as id_key,
  tc_mantic_articulos_codigos.codigo,
  tc_mantic_articulos.nombre,
  tc_mantic_articulos.precio      
from
  tc_mantic_articulos
inner join  
  tc_mantic_articulos_codigos on tc_mantic_articulos_codigos.id_articulo= tc_mantic_articulos.id_articulo and tc_mantic_articulos_codigos.id_principal= 1 and tc_mantic_articulos_codigos.id_proveedor is null
where  
  tc_mantic_articulos.id_articulo_tipo= {idArticuloTipo}
			</select>		
    </unit>    
	</dml>    
</process>
